#!/usr/bin/env bash
# Properly configures Nginx to listen on port 80 with correct symlink setup

# Exit on any error
set -e

# Install Nginx if not present
if ! command -v nginx >/dev/null; then
    apt-get update
    apt-get install -y nginx
fi

# Ensure sites-available/default exists
if [ ! -f /etc/nginx/sites-available/default ]; then
    mkdir -p /etc/nginx/sites-available
    cat > /etc/nginx/sites-available/default <<'EOF'
server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    root /var/www/html;
    index index.html index.htm;
    
    server_name _;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
EOF
fi

# Clean up sites-enabled directory
rm -f /etc/nginx/sites-enabled/*

# Create proper symlink
ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default

# Test the configuration
if nginx -t; then
    # Restart Nginx
    if command -v systemctl >/dev/null; then
        systemctl restart nginx
    else
        nginx -s stop 2>/dev/null || true
        nginx
    fi
    echo "Nginx successfully configured on port 80"
else
    echo "Nginx configuration test failed"
    exit 1
fi
