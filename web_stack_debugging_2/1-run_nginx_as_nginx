#!/usr/bin/env bash
# Configures Nginx to run as nginx user on port 8080

# 1. Stop any running Nginx and free port 8080
nginx -s stop 2>/dev/null || true
pkill -9 nginx 2>/dev/null || true
fuser -k 8080/tcp 2>/dev/null || true

# 2. Create required directories
mkdir -p /var/cache/nginx /var/log/nginx /var/www/html
echo "Nginx is working" > /var/www/html/index.html

# 3. Create nginx user if it doesn't exist
id -u nginx &>/dev/null || useradd --system --no-create-home nginx

# 4. Configure Nginx
cat > /etc/nginx/nginx.conf <<EOF
user nginx;
worker_processes auto;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
    
    server {
        listen 8080;
        listen [::]:8080;
        server_name localhost;
        
        location / {
            root /var/www/html;
            index index.html;
        }
    }
}
EOF

# 5. Set proper permissions
chown -R nginx:nginx /var/cache/nginx /var/log/nginx /var/www/html
chmod -R 755 /var/cache/nginx /var/log/nginx /var/www/html

# 6. Start Nginx
nginx -t && nginx

# 7. Verification
echo -e "\n=== Nginx processes ==="
ps aux | grep ngin[x]

echo -e "\n=== Port check ==="
netstat -tulnp | grep 8080 || ss -tulnp | grep 8080

echo -e "\n=== HTTP check ==="
curl -s localhost:8080
